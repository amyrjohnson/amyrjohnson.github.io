
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Amy R. Johnson</title>
  <meta name="author" content="Amy Johnson">

  
  <meta name="description" content="Once we knew what the source of the performance issues was, my mentor and I could begin optimizing. From our initial benchmarking, it was clear the &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://amyrjohnson.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Amy R. Johnson" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
  


  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />

</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Amy R. Johnson</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:amyrjohnson.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/19/troubleshooting-performance-in-ruby-part-2/">Troubleshooting Performance in Ruby, Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-19T13:43:34-04:00" pubdate data-updated="true">Oct 19<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Once we knew what the source of the performance issues was, my mentor and I could begin optimizing. From our initial benchmarking, it was clear the <code>get_pictures</code> function needed some work. This is the function responsible for requesting photos with the given search term from Google&rsquo;s image search API, then downloading them and reading them into memory. Here&rsquo;s the function before optimization:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> #takes 59.405176 seconds
</span><span class='line'>
</span><span class='line'>  def get_pictures
</span><span class='line'>      @photo_tiles = ImageList.new
</span><span class='line'>      limit = 50
</span><span class='line'>      photos_per_query = 10
</span><span class='line'>      api_key = API_KEY
</span><span class='line'>      id = SEARCH_ENGINE_ID
</span><span class='line'>      start = 1
</span><span class='line'>      (1..limit).step(photos_per_query) { |start|
</span><span class='line'>        source = "https://www.googleapis.com/customsearch/v1?q=#{search_term}&cx=#{id}&num=#{photos_per_query}&searchType=image&key=#{api_key}"
</span><span class='line'>        data = JSON.load(open(source))
</span><span class='line'>        (0...photos_per_query).each {|i|
</span><span class='line'>            @photo_tiles.read(data["items"][i]["link"])
</span><span class='line'>        }
</span><span class='line'>      } rescue 'no more images found'
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  </span></code></pre></td></tr></table></div></figure>


<p>The first thing we noticed by browsing through the links Google returned was that some of these images were huge! Since the images are being resized to be used as small tiles in a photo mosaic, the extra time downloading larger images is completely wasted. One option to resolve this issue would be to check the size of the photo before downloading it, but thankfully Google provides size range parameters to restrict the result set to small or medium photos so no checks are necessary. Since we settled on a photo tile size of 10x10 pixels, even the thumbnails worked for our purposes.</p>

<p>We also noticed as the function ran it would seem to get hung up on individual photos. Visiting those links sent us to non-responsive or slow pages. To combat that issue we added a rescue clause to the <code>read</code> statement, so the program would continue on in the case of a bad link.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>  def get_pictures
</span><span class='line'>      @photo_tiles = ImageList.new
</span><span class='line'>      limit = 50
</span><span class='line'>      photos_per_query = 10
</span><span class='line'>      api_key = API_KEY
</span><span class='line'>      id = SEARCH_ENGINE_ID
</span><span class='line'>      start = 1
</span><span class='line'>      (1..limit).step(photos_per_query) { |start|
</span><span class='line'>        source = "https://www.googleapis.com/customsearch/v1?q=#{search_term}&cx=#{id}&num=#{photos_per_query}&searchType=image&key=#{api_key}"
</span><span class='line'>        data = JSON.load(open(source))
</span><span class='line'>        (0...photos_per_query).each {|i|
</span><span class='line'>            @photo_tiles.read(data["items"][i]["link"])
</span><span class='line'>        }
</span><span class='line'>      } rescue 'no more images found'
</span><span class='line'>  end
</span></code></pre></td></tr></table></div></figure>


<p>Running the whole search process with benchmarking now gives:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>=&gt; Getting pictures took 14.296446
</span><span class='line'>resizing pictures took 0.054123
</span><span class='line'>getting picture colors took 0.007894
</span><span class='line'>search took 14.361774</span></code></pre></td></tr></table></div></figure>


<p>Simply changing the picture size and adding a rescue clause reduced the total time by 75%! However, this example is for a small number of total tiles. My mentor and I decided we could reduce the total time even further by adding more threads to the download process. That way, instead of waiting for each image to download completely before moving on to the next one, they can be downloaded concurrently. Since the download of one image doesn&rsquo;t depend on any other one, there&rsquo;s no need to download them one by one. Using more threads speeds up the amount of time the download portion takes.</p>

<p>However, reading the images once they&rsquo;ve been downloaded has to be done one by one. In the original function the files are being downloaded and read in one line, so we need to separate the downloading from the reading in order to use threading.</p>

<p>For each photo, we create a new thread (<code>Thread.new</code>) to open the image from a link and read it into a temporary file. Then, since all the images need to be finished downloading before we read them, the threads need to be joined using <code>thread.join</code>. Finally, we loop through the temporary files we created and read each one.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def get_pictures
</span><span class='line'>  @photo_tiles = ImageList.new
</span><span class='line'>  limit = 50
</span><span class='line'>  photos_per_query = 10
</span><span class='line'>  api_key = API_KEY
</span><span class='line'>  id = SEARCH_ENGINE_ID
</span><span class='line'>  timeout_in_seconds = 1
</span><span class='line'>  threads = []
</span><span class='line'>  start = 1
</span><span class='line'>  (1..limit).step(photos_per_query) { |start|
</span><span class='line'>    source = "https://www.googleapis.com/customsearch/v1?q=#{self.search_term}&cx=#{id}&num=#{photos_per_query}&searchType=image&start=#{start}&key=#{api_key}&imageSize=Medium&fileType=jpg"
</span><span class='line'>    data = JSON.load(open(source))
</span><span class='line'>    (0...photos_per_query).each {|i|
</span><span class='line'>        threads &lt;&lt; Thread.new { 
</span><span class='line'>          open("tmp/image_#{start}_#{i}", 'wb') do |file|
</span><span class='line'>            file &lt;&lt; open(data["items"][i]["image"]["thumbnailLink"]).read rescue puts 'Cannot read image'
</span><span class='line'>          end
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>    }
</span><span class='line'>  } rescue 'no more images found'
</span><span class='line'>
</span><span class='line'>  threads.each do |t|
</span><span class='line'>     t.join
</span><span class='line'>  end
</span><span class='line'>
</span><span class='line'>  (1..limit).step(photos_per_query) do |start|
</span><span class='line'>     (0...photos_per_query).each do |i|
</span><span class='line'>        @photo_tiles.read("tmp/image_#{start}_#{i}") rescue puts 'Cannot read image'
</span><span class='line'>     end
</span><span class='line'>  end
</span><span class='line'>end
</span></code></pre></td></tr></table></div></figure>


<p>Now let&rsquo;s check our performance:</p>

<p>&#8220;
$ i.make_mosaic(50, 50, 10, 10)</p>

<p>=> getting pixels took 0.959601
Getting pictures took 4.384112
resizing pictures took 0.055782
getting picture colors took 0.005212
search took 4.448468
matching pixels with image tiles took 0.087612
putting tiles in order took 0.089187
ordering photos took 0.007696
making mosaic took 0.290649
total time 5.883285
&#8220;`</p>

<p>Dividing the work among multiple threads reduced the time the <code>get_pictures</code> function took from 14 seconds to 4 seconds. The whole mosaic operation now takes only 6 seconds, down from an original 69. However, this is still for only a small number of photo tiles. Larger mosaics with higher resolution tiles might require more performance improvements.</p>

<p>To learn more about threads in Ruby check out this <a href="http://www.sitepoint.com/threads-ruby/">tutorial</a> from Sitepoint.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/19/troubleshooting-performance/">Troubleshooting Performance in Ruby, Part 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-19T11:25:19-04:00" pubdate data-updated="true">Sep 19<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>During my fellowship at Stack Exchange I&rsquo;ve been working on a photo mosaic application using Rails and RMagick, a wrapper on ImageMagick for Ruby. The application takes an uploaded image and a search term from the user and returns a mosaic of that image created from google image search results for the given term.</p>

<p>The main issue I ran into when working on this application was how slow it ran. From start to finish the process of creating the mosaic took several minutes, even for a small number of photo tiles. My mentor at Stack Exchange helped me come up with several strategies to tackle this issue and speed up the application.</p>

<p>The first step to improving the performance of the application was discovering exactly which processes were causing it to be slow. This would also provide a baseline performance metric to compare against once we implemented optimizations. In order to do this we added in some simple benchmarks. Before and after each process that was run, I printed out a system timestamp.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def make_mosaic(photo_length, photo_width, tile_length, tile_width)
</span><span class='line'>    time1 = Time.now
</span><span class='line'>    self.get_pixels(photo_length, photo_width)
</span><span class='line'>    time2 = Time.now
</span><span class='line'>    puts "getting pixels took #{time2 - time1}"
</span><span class='line'>    s = Search.new(self.search)
</span><span class='line'>    s.complete_search(tile_length, tile_width)
</span><span class='line'>    time3 = Time.now
</span><span class='line'>    puts "completing search took #{time3 - time2}"
</span><span class='line'>    self.match_pixels(s.photo_tile_colors)
</span><span class='line'>    time4 = Time.now
</span><span class='line'>    puts "matching pixels with image tiles took #{time4 - time3}"
</span><span class='line'>    self.order_tiles(s.resized_photo_tiles)
</span><span class='line'>    time5 = Time.now
</span><span class='line'>    puts "putting tiles in order took #{time5 - time4}"
</span><span class='line'>    m = Mosaic.new
</span><span class='line'>    puts "ordering photos for mosaic"
</span><span class='line'>    photos = m.order_photos(self.ordered_tiles, self.rows, self.cols, tile_length, tile_width)
</span><span class='line'>    puts "making mosaic"
</span><span class='line'>    m.create_mosaic(photos)
</span><span class='line'>    puts "making mosaic took #{Time.now - time5}"
</span><span class='line'>    puts "total time: #{Time.now - time}""
</span><span class='line'>end 
</span></code></pre></td></tr></table></div></figure>


<p>Although writing out the <code>puts</code> statements was time consuming, it gave me great readable output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>=&gt; getting pixels took 0.983399
</span><span class='line'>search took 71.075624
</span><span class='line'>matching pixels with image tiles took 0.134034
</span><span class='line'>putting tiles in order took 0.16947
</span><span class='line'>ordering photos took 0.046765
</span><span class='line'>making mosaic took 0.202503
</span><span class='line'>total time 72.611871
</span></code></pre></td></tr></table></div></figure>


<p>Initially I&rsquo;d thought that assembling the photos into a mosaic has been taking the longest amount of time, but from this initial output, I was able to pinpoint the source of the delay to the photo search function. From there I put further benchmarks into the search function to get more information.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def complete_search(tile_length, tile_width)
</span><span class='line'>  time = Time.now
</span><span class='line'>  self.get_pictures
</span><span class='line'>  time2 = Time.now
</span><span class='line'>  puts "Getting pictures took #{time2 - time}"
</span><span class='line'>  self.resize_pictures(tile_length, tile_width)
</span><span class='line'>  time3 = Time.now
</span><span class='line'>  puts  "resizing pictures took #{time3 - time2}"
</span><span class='line'>  self.average_color_list
</span><span class='line'>  time4 = Time.now 
</span><span class='line'>  puts "getting picture colors took #{time4 - time3}"
</span><span class='line'>
</span><span class='line'>end
</span><span class='line'>
</span><span class='line'>=&gt; Getting pictures took 59.405176
</span><span class='line'>resizing pictures took 9.876595
</span><span class='line'>getting picture colors took 0.031038
</span><span class='line'>search took 69.316089
</span></code></pre></td></tr></table></div></figure>


<p>By far the slowest operation was downloading the photos and reading them into memory. This was taking 59 seconds out of a total 72 seconds! Now that I had a clear idea of how long the process was taking and which part was the bottleneck, I could begin to optimize. In part two of this post, I&rsquo;ll show you my next steps.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/28/rickshaw/">Creating a Realtime Graph With Rickshaw and Heroku Scheduler</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-28T21:57:35-04:00" pubdate data-updated="true">Jul 28<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://code.shutterstock.com/rickshaw/">Rickshaw</a> is a really cool JavaScript graphing library by Shutterstock built on d3. I decided to create a realtime visualization of Citi Bike data from their JSON feed. (It&rsquo;s still a work in progress, check it out <a href="http://polar-spire-8762.herokuapp.com/realtime">here</a>.)</p>

<p>To set up even a simple graph, you have to download the Rickshaw JavaScript and css files and reference them correctly. The more complicated your graph is the more of these there will be, so be sure you put everything in the right place. In my realtime graph there were many more, but for a basic line graph the links look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;../src/css/sample.css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;../src/css/graph.css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;css/lines.css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/d3.v3.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;js/rickshaw.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;chart&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next important component is getting the realtime data from the Citi Bike feed. I accomplished this using an AJAX request. The Rickshaw example realtime graph includes a helpful SetInterval function that will repeat the AJAX request at a specificed interval. Once the request is complete I send the data to a callback function that parses and adds it, and the <code>graph.update()</code> function displays the updated graph.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">setInterval</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">newRemoveData</span><span class="p">(</span><span class="nx">seriesData</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">url</span><span class="o">:</span> <span class="nx">citibikeurl</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&quot;jsonp&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">crossDomain</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">json</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">sortNeighborhoods</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="c1">// repeats previous datapoint if bike feed request is unsuccessful</span>
</span><span class='line'>           <span class="nx">newAddData</span><span class="p">([</span><span class="nx">seriesData</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="nx">seriesData</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nx">seriesData</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;y&quot;</span><span class="p">]);</span>
</span><span class='line'>           <span class="nx">newAddData</span><span class="p">([</span><span class="nx">seriesData</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="nx">seriesData</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nx">seriesData</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;y&quot;</span><span class="p">]);</span>
</span><span class='line'>           <span class="nx">newAddData</span><span class="p">([</span><span class="nx">seriesData</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="nx">seriesData</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="nx">seriesData</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;y&quot;</span><span class="p">]);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>    <span class="nx">graph</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="p">},</span> <span class="mi">2000</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Looking at the data, I decided it would be interesting to graph the number of available bikes by area. The callback function classifies each station by its longitude and latitude and adds its bikes to the total count for its respective neighborhood.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">function</span> <span class="nx">sortNeighborhoods</span><span class="p">(</span><span class="nx">json</span><span class="p">){</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">midtownBikes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">brooklynBikes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">downtownBikes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>       <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">json</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">&quot;lng&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">73971000</span> <span class="o">||</span> <span class="p">(</span><span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">40705311</span> <span class="o">&amp;&amp;</span> <span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">&quot;lng&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">73999978</span><span class="p">)){</span>
</span><span class='line'>            <span class="nx">brooklynBikes</span> <span class="o">+=</span> <span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">&quot;bikes&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">40740895</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">midtownBikes</span> <span class="o">+=</span> <span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">&quot;bikes&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">40740895</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">downtownBikes</span> <span class="o">+=</span> <span class="nx">json</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">&quot;bikes&quot;</span><span class="p">]</span>
</span><span class='line'>            <span class="p">};</span>
</span><span class='line'>       <span class="p">};</span>
</span><span class='line'>    <span class="nx">newAddData</span><span class="p">([</span><span class="nx">seriesData</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="nx">midtownBikes</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">newAddData</span><span class="p">([</span><span class="nx">seriesData</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="nx">downtownBikes</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">newAddData</span><span class="p">([</span><span class="nx">seriesData</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="nx">brooklynBikes</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once you have the data in the graph, Rickshaw has lots of options you can customize, from color palatte to annotations and hover detail. The syntax for these is pretty straightforward and can be found in the documentation and by looking at the example graphs provided on their website.</p>

<p>The next interesting problem I faced was seeding the graph with some recent data before the page rendered so the user didn&rsquo;t have to wait for the graph to populate. I set up a Postgres database and created a simple rake task to grab the realtime data, just like in my graph, but write it to the database instead of rendering it. That way a rolling log of data would be available to populate the graph.</p>

<p>In order for the data to be current, the rake task needs to be run at regular intervals automatically, which is where the <a href="https://devcenter.heroku.com/articles/scheduler">Heroku scheduler add-on</a> comes in. This add-on is free and can be added to your existing heroku application using the command <code>$ heroku addons:add scheduler:standard</code>. Then, in your Heroku dashboard you can specify the rake task you want run and the interval, as often as every 10 minutes. Because I can&rsquo;t have the task run as often as my data source updates, I added code to interpolate between the most recent points to make the graph smoother.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/27/making-a-simple-browser-game-with-sinatra/">Making a Simple Browser Game With Sinatra</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-27T10:05:43-04:00" pubdate data-updated="true">Jun 27<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post details how I made a simple tic-tac-toe game using Sinatra.</p>

<p>The first step is creating the code that contains the logic of the game. There are a ton of different ways to do this, and Sinatra doesn&rsquo;t care which way you choose. I decided to make a game class, a board class, and a player class. The game class contains the logic pertaining to turns and the running of the game, initialized with an empty board and two players. The board class stores the gameboard as a 3x3 matrix, updates itself with every turn, and determines when the game has ended in a win, loss, or tie. The player class stores the player attributes like name and marker.</p>

<p>The next step is to move the Ruby logic into a Sinatra application. To make things a little easier, I used <a href="https://github.com/ashleygwilliams/ratpack">Ratpack</a>, a Sinatra boilerplate by <a href="http://about.me/ashley_williams">Ashley Williams</a> with support for activerecord, sqlite, and twitter bootstrap (even though we won&rsquo;t be using the database functionality for this application). In the Ratpack schema the models live in the <code>lib</code> directory.</p>

<p>Now we can ignore our tic-tac-toe logic for a little bit and get our pages set up. First we need to define a class that inherits from Sinatra so that we can use all of Sinatra&rsquo;s functionality in our application. Next create the routes. Each page needs a route in order to render, which we establish here with <code>get</code> statements.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">TicTacToeProject</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">App</span> <span class="o">&lt;</span> <span class="ss">Sinatra</span><span class="p">:</span><span class="ss">:Application</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#routes</span>
</span><span class='line'>    <span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">erb</span> <span class="ss">:index</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">get</span> <span class="s1">&#39;/play&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">erb</span> <span class="ss">:play</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>erb :filename</code> statements are telling Sinatra what to render. In this case that&rsquo;s the erb files from my views folder. In order to make a board show up in the browser, I need to display each square from my board in my html, which is easy to do using erb. I chose to format the board as three rows with three columns each, but you could just as easily use a table or some other method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!-- views/play.erb --&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;board&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row center&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-md-4&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h2&gt;</span><span class="err">&lt;</span>%= game.square(0,0) %&gt;<span class="nt">&lt;/h2&gt;</span> <span class="c">&lt;!-- returns the value in square [0,0] --&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-md-4 v&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h2&gt;</span><span class="err">&lt;</span>%= game.square(0,1) %&gt;<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>   <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-md-4&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;h2&gt;</span><span class="err">&lt;</span>%= game.square(0,2) %&gt;<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The only problem is, this erb file has no idea what <code>game</code> is. I need to pass the instance of my game class in my route in order for my views to render it. That looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app.rb</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">TicTacToeProject</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">App</span> <span class="o">&lt;</span> <span class="ss">Sinatra</span><span class="p">:</span><span class="ss">:Application</span>
</span><span class='line'>    <span class="vc">@@game</span> <span class="o">=</span> <span class="no">PlayGame</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#routes</span>
</span><span class='line'>    <span class="n">get</span> <span class="s1">&#39;/&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@game</span> <span class="o">=</span> <span class="vc">@@game</span>
</span><span class='line'>      <span class="n">erb</span> <span class="ss">:index</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">get</span> <span class="s1">&#39;/play&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@game</span> <span class="o">=</span> <span class="vc">@@game</span>
</span><span class='line'>      <span class="n">erb</span> <span class="ss">:play</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once I&rsquo;ve created views and routes for all my pages I&rsquo;m most of the way there, but how do I get input from the user to allow them to play the game? One simple way to receive input from a user and store it for access later is to include a form in the view.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!-- views/play.erb --&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/move&quot;</span> <span class="na">method=</span><span class="s">&quot;get&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;move&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;Submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Play&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/form&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The text input of the form, which I named &ldquo;move&rdquo;, is stored in Sinatra&rsquo;s params hash automatically. I can access whatever the user typed elsewhere in my program using the <code>params[:move]</code> variable. Now I can update the board with the player&rsquo;s move before loading the erb in my route.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app.rb</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">get</span> <span class="s1">&#39;/move&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="vc">@@game</span><span class="o">.</span><span class="n">play</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="s2">&quot;move&quot;</span><span class="o">]</span><span class="p">)</span> <span class="c1">#updates the gameboard with the player&#39;s chosen move</span>
</span><span class='line'>      <span class="vi">@game</span> <span class="o">=</span> <span class="vc">@@game</span>
</span><span class='line'>      <span class="n">erb</span> <span class="ss">:move</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p> We&rsquo;re almost done! Now we can get a move from the player, update the board, and render a page displaying the updated board. However, if you were to run the code using the Shotgun gem you&rsquo;d soon discover a problem. Every time the player moves the board will update, but when the player goes to make a second move they&rsquo;ll find their previous move has been erased and the board is blank! The reason for this is that every time Shotgun rereads the Sinatra application to refresh the content it generates a new instance of the class App. So every time it runs, it creates a new instance of the PlayGame class, making a new game rather than updating an in-progress game. Try using Rackup instead, and the game should work as intended.</p>

<p>And now we have a working game! Fix up the views with twitter bootstrap, and we&rsquo;re all done. You can check out my finished version at <a href="amystictactoegame.herokuapp.com">amystictactoegame.herokuapp.com</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/06/11/my-first-post-on-octopress/">Matrices in Ruby</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-11T13:05:08-04:00" pubdate data-updated="true">Jun 11<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Ruby has a matrix library that can be used to do simple linear algebra. The Matrix class defines useful methods like transpose, rank, and determinant. This is nice, because a lot of practical problems can be formulated in terms of linear algebra. Say that we have the following data about recently sold homes:</p>

<table>
<thead>
<tr>
<th> Table  </th>
<th align="left"> Square Footage </th>
<th align="left"> # Bathrooms   </th>
<th align="left"> Price </th>
</tr>
</thead>
<tbody>
<tr>
<td>House 0 </td>
<td align="left">4000            </td>
<td align="left">3              </td>
<td align="left">400000 </td>
</tr>
<tr>
<td>House 1 </td>
<td align="left">3000            </td>
<td align="left">2              </td>
<td align="left">310000 </td>
</tr>
<tr>
<td>House 2 </td>
<td align="left">3800            </td>
<td align="left">3              </td>
<td align="left">375000  </td>
</tr>
<tr>
<td>House 3 </td>
<td align="left">3200            </td>
<td align="left">2              </td>
<td align="left">315000 </td>
</tr>
<tr>
<td>House 4 </td>
<td align="left">3542            </td>
<td align="left">4              </td>
<td align="left">350000 </td>
</tr>
<tr>
<td>House 5 </td>
<td align="left">2348            </td>
<td align="left">2              </td>
<td align="left">250000 </td>
</tr>
<tr>
<td>House 6 </td>
<td align="left">2987            </td>
<td align="left">3              </td>
<td align="left">300000 </td>
</tr>
<tr>
<td>House 7 </td>
<td align="left">4300            </td>
<td align="left">4              </td>
<td align="left">450000 </td>
</tr>
<tr>
<td>House 8 </td>
<td align="left">3342            </td>
<td align="left">4              </td>
<td align="left">360000 </td>
</tr>
<tr>
<td>House 9 </td>
<td align="left">3000            </td>
<td align="left">3              </td>
<td align="left">320000 </td>
</tr>
</tbody>
</table>


<br>


<p>The data has, for each house, the square footage, number of bathrooms, and the price that the house sold for. If you wanted to predict what price another house (not in this data set) might sell for, and you knew its size and bathroom count, you could use the Matrix class to perform a linear regression on the data.</p>

<p>In linear regression we attempt to express our dependent variable (in this case, housing price), as a linear combination of the independent variables (bathrooms and square footage) plus some constant.</p>

<p><strong><center>f(x,y) = ax + by + c</center></strong></p>

<p>For any given triplet of datapoints (square footage, number of bathrooms, and price), the difference between the actual price and the price predicted by our equation, squared is the pointwise error. In order to determine the values of a, b, and c that make the most sense, we choose the values that minimize the total average squared error. If the data can be expressed as an matrix X such that X<sup>T</sup>X is invertible, there is an easy formula to get the right values:</p>

<p><strong><center>w = (X<sup>T</sup>X)<sup>-1</sup>X<sup>T</sup>b</center></strong></p>

<p>where w is the matrix containing the coefficients <code>a</code>, <code>b</code>, and <code>c</code>, <code>X</code> represents the dependent variable matrix, and <code>b</code> represents the independent variable matrix.</p>

<p>With the Ruby matrix class these manipulations will be easy. Creating matrices in Ruby is simple. First add a line to require the matrix library, and you&rsquo;re ready to get started. Ruby stores each matrix as an array of rows. Just like arrays, the indices of matrix rows and columns start at zero. Don&rsquo;t forget that all the rows must be the same length for the matrix to be valid.</p>

<p>Here we enter the data from the table into two matrices. Matrices can be instantiated in a variety of ways. I chose to simply list out the rows as nested arrays, and unless specified otherwise that&rsquo;s what Ruby assumes the input will be. Each row represents a house with square footage in column 1 (the second column since ruby indexes columns from 0) and the number of bathrooms in column 2. The constant value in column 0 is necessary for the calculation of the constant c from our previous equation. The second matrix contains the housing prices. These two matrices are all we need for our calculations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>require 'matrix'
</span><span class='line'>
</span><span class='line'>housing_data = Matrix[[1,4000,3], 
</span><span class='line'>                      [1,3000,2], 
</span><span class='line'>                      [1,3800,3], 
</span><span class='line'>                      [1,3200,2], 
</span><span class='line'>                      [1,3542,4], 
</span><span class='line'>                      [1,2348,2],
</span><span class='line'>                      [1,2987,3],
</span><span class='line'>                      [1,4300,4],
</span><span class='line'>                      [1,3342,4],
</span><span class='line'>                      [1,3000,3]
</span><span class='line'>                      ]
</span><span class='line'>
</span><span class='line'>housing_prices = Matrix[[400000],
</span><span class='line'>                      [310000],
</span><span class='line'>                      [375000],
</span><span class='line'>                      [315000],
</span><span class='line'>                      [350000],
</span><span class='line'>                      [250000],
</span><span class='line'>                      [300000],
</span><span class='line'>                      [450000],
</span><span class='line'>                      [360000],
</span><span class='line'>                      [320000]
</span><span class='line'>                      ]</span></code></pre></td></tr></table></div></figure>


<p> So, to get started on our handy equation, let&rsquo;s transpose <code>X</code>, our housing data matrix. Ruby has a useful function that will transpose a matrix for you, as you can see above.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">x_t</span> <span class="o">=</span> <span class="n">housing_data</span><span class="o">.</span><span class="n">transpose</span>
</span><span class='line'>
</span><span class='line'> <span class="o">=&gt;</span> <span class="no">Matrix</span><span class="o">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="o">[</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">3000</span><span class="p">,</span> <span class="mi">3800</span><span class="p">,</span> <span class="mi">3200</span><span class="p">,</span> <span class="mi">3542</span><span class="p">,</span> <span class="mi">2348</span><span class="p">,</span> <span class="mi">2987</span><span class="p">,</span> <span class="mi">4300</span><span class="p">,</span> <span class="mi">3342</span><span class="p">,</span> <span class="mi">3000</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="o">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p> Next we multiply the trasposed matrix by the original housing data matrix. The standard operators of <code>*, +, -, /,</code> and <code>**</code> perform the corresponding operations on matrices.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">x_t_x</span> <span class="o">=</span> <span class="n">x_t</span> <span class="o">*</span> <span class="n">housing_data</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="no">Matrix</span><span class="o">[[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">33519</span><span class="p">,</span> <span class="mi">30</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="o">[</span><span class="mi">33519</span><span class="p">,</span> <span class="mi">115320001</span><span class="p">,</span> <span class="mi">103193</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="o">[</span><span class="mi">30</span><span class="p">,</span> <span class="mi">103193</span><span class="p">,</span> <span class="mi">96</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can invert the resulting matrix using the inverse method.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">x_t_x</span><span class="o">.</span><span class="n">inverse</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">=&gt;</span> <span class="no">Matrix</span><span class="o">[[</span><span class="p">(</span><span class="mi">421924847</span><span class="o">/</span><span class="mi">108574934</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">61017</span><span class="o">/</span><span class="mi">54287467</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">673863</span><span class="o">/</span><span class="mi">108574934</span><span class="p">)</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>            <span class="o">[</span><span class="p">(</span><span class="o">-</span><span class="mi">61017</span><span class="o">/</span><span class="mi">54287467</span><span class="p">),</span> <span class="p">(</span><span class="mi">30</span><span class="o">/</span><span class="mi">54287467</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">13180</span><span class="o">/</span><span class="mi">54287467</span><span class="p">)</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>            <span class="o">[</span><span class="p">(</span><span class="o">-</span><span class="mi">673863</span><span class="o">/</span><span class="mi">108574934</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">13180</span><span class="o">/</span><span class="mi">54287467</span><span class="p">),</span> <span class="p">(</span><span class="mi">29676649</span><span class="o">/</span><span class="mi">108574934</span><span class="p">)</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, we can get the coefficients matrix with two more multiplication operations. Those fractions look pretty unwieldy, so let&rsquo;s iterate through the matrix and change them to floating point numbers to get a better idea of what&rsquo;s going on.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_t_x</span><span class="o">.</span><span class="n">inverse</span> <span class="o">*</span> <span class="n">x_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">housing_prices</span>
</span><span class='line'>
</span><span class='line'> <span class="o">=&gt;</span> <span class="no">Matrix</span><span class="o">[[</span><span class="p">(</span><span class="mi">1018615352500</span><span class="o">/</span><span class="mi">54287467</span><span class="p">)</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="o">[</span><span class="p">(</span><span class="mi">4850790000</span><span class="o">/</span><span class="mi">54287467</span><span class="p">)</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="o">[</span><span class="p">(</span><span class="mi">447540942500</span><span class="o">/</span><span class="mi">54287467</span><span class="p">)</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Matrix.each</code> reads left to right, then down the rows by default, but you can also specify options, for instance only reading down the diagonal (<code>row index == column index</code>). Since here we only have a simple [3x1] matrix, the default method works just fine. Rather than initializing and returning a new matrix, we can also just use the <code>collect</code> method in place of <code>each</code> to return the new matrix automatically.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">w</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="n">i</span><span class="o">.</span><span class="n">to_f</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="o">=&gt;</span> <span class="no">Matrix</span><span class="o">[[</span><span class="mi">18763</span><span class="o">.</span><span class="mi">36</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="o">[</span><span class="mi">89</span><span class="o">.</span><span class="mi">35</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>          <span class="o">[</span><span class="mi">8243</span><span class="o">.</span><span class="mi">91</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>And there we have the coefficients in a matrix. The constant, c, is in row 0, the square footage coefficient, b, is in row 1, and the bathroom coeffient, a, is in row 2 (note that this mirrors the column structure of the original data matrix). As we would expect, both a and b are positive since higher square footage and more bathrooms are both associated with a higher price. Additionally, the magnitude of the coefficient for square footage (row 1) is much smaller than the one for bathrooms, since square footage is a much bigger number than bathroom count. Let&rsquo;s revisit our original example of a 3500 square foot house with 3 bathrooms and determine the predicted price.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="mi">8243</span><span class="o">.</span><span class="mi">91</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">89</span><span class="o">.</span><span class="mi">35</span><span class="o">*</span><span class="mi">3500</span> <span class="o">+</span> <span class="mi">18763</span><span class="o">.</span><span class="mi">36</span>
</span><span class='line'>
</span><span class='line'> <span class="o">=&gt;</span> <span class="mi">356220</span><span class="o">.</span><span class="mi">08999999997</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our equation predicts that this house would sell for $356,220, which makes sense compared to the other points in our data set.</p>

<p>For more information on using matrices in Ruby checkout the <a href="http://www.ruby-doc.org/stdlib-2.0/libdoc/matrix/rdoc/Matrix.html">Ruby Documentation</a> and this <a href="http://rubylearning.com/blog/2013/04/04/ruby-matrix-the-forgotten-library/">helpful post</a> from RubyLearning Blog.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Amy Johnson -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
